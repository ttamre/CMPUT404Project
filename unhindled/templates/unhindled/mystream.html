<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Unhindled</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'unhindled/style.css' %}" />
</head>

<body>
    {% #header user=user %}
    {% /header %}
    <main>
        <div>
            {% if user.is_authenticated %}
            <p class="non-white-title">My Stream</p>
            {% if object_list %}
                {% for post in object_list %}
                <!-- change this to ID when author and user are matched -->
                {% if post.author.username == user.username %}
                    <div class="post">
                        <a href="{% url 'viewPost' post.author.username post.pk %}">{{ post.title }}</a> <br>
                        By: {{ post.author }} <br>
                        {{ post.description }}
                    </div>
                {% endif %}
                {% endfor %}
                <h3>Sent to me</h3>
                {% for post in object_list %}
                {% if post.send_to.username == user.username and post.visibility == "send" %}
                    <div class="post">
                        <a href="{% url 'viewPost' post.author.username post.pk %}">{{ post.title }}</a> <br>
                        By: {{ post.author }} <br>
                        {{ post.description }}
                    </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <p>No Posts to show.</p>
            {% endif %}
            {% endif %}


            <!-- Github Activity -->
            <h3>Github Activity</h3>

            <!-- safely loading request headers from python -->
            {{ headers|json_script:"headers" }}

            <script>
                function fillTable() {
                    var eventList = getGithubActivity();
                    var table = document.getElementById("github_table")

                    for (event in eventList) {
                        const repo = document.createElement('td')
                        repo.appendChild(document.createTextNode(event['repo']));

                        const type = document.createElement('td')
                        type.appendChild(document.createTextNode(event['type']));
                        
                        const url = document.createElement('td')
                        url.appendChild(document.createTextNode(event['url']));

                        const row = document.createElement('tr')
                        row.appendChild(repo);
                        row.appendChild(activity);
                        row.appendChild(link);
                        table.appendChild(row);
                    }
                }

                function getRepoLink(link, auth, backup=null) {
                    var request = new XMLHttpRequest();
                    request.setRequestHeader('Authorization', auth)
                    request.open("GET", link, false);

                    request.onreadystatechange = function () {
                        if (request.readyState == 4) {
                            try {
                                if (request.status == 200) {
                                    // Successful request: Public repo (we can get the link)
                                    var data = JSON.parse(request.responseText);
                                    return data?.['html_url'];
                                }
                            }
                            catch(e) {
                                // Unsuccessful request: Private repo (get the user's profile link instead)
                                if (backup) { getRepoLink(backup, auth); }
                            }
                            finally {
                                alert('Error: ' + e.name)
                                return ""
                            }
                        }
                    }
                }

                function getGithubActivity() {
                    GITHUB_EVENTS = {
                        "CreateEvent": "Created repository",
                        "PushEvent":   "Pushed code",
                        "PullEvent":   "Pulled code",
                        "ForkEvent":   "Forked repo",
                        "MemberEvent": "Managed organization",
                        "PullRequestEvent": "Pull request",
                        "unknown": "Unknown event",
                        null: "Unknown event"
                    }

                    // Get request headers
                    const headers = JSON.parse(document.getElementById('headers').textContent);

                    // AJAX request to get Github activiy data
                    var activityRequest = new XMLHttpRequest();
                    activityRequest.open('GET', headers['uri'], false);

                    activityRequest.onreadystatechange = function () {
                        if (activityRequest.readyState == 4) {
                            try {
                                if (activityRequest.status == 200) {
                                    var events = JSON.parse(activityRequest.responseText);
                                    var eventList = [];

                                    for (event in events) {
                                        var repo = event?.['repo']?.['name']
                                        var type = GITHUB_EVENTS[event?.['type']]

                                        var repo_api = event?.['repo']?.['url']
                                        var user_api = event?.['actor']?.['url']
                                        var url = getRepoLink(repo_api, headers['auth'], user_api);

                                        event_list.push({"repo": repo, "type": type, "url": url,});
                                    }

                                    return eventList;
                                }
                            }
                            catch (e) {
                                alert('Error: ' + e.name);
                            }
                        }
                    };

                    activityRequest.send();
                }

            fillTable();
            </script>

            <table id="github_table">
                <tr>
                    <th>Repository</th>
                    <th>Activity</th>
                    <th>Link to repo</th>
                </tr>

                <!-- tr>
                <td id="table_repo"></td>
                <td id="table_activity"></td>
                <td id="table_link"><a href=""></a></td>
              </tr-->

            </table>
        </div>
    </main>
</body>

</html>